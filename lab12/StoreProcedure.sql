-- 建立关系“点赞排行榜【博文ID，当天点赞人数】”，里面存储系统当天点赞数前十名的博文ID及其点赞人数，尝试编写一个DBMS的存储过程，通过该存储过程更新该表。

DROP TABLE IF EXISTS TOPTHUMB;
CREATE TABLE TOPTHUMB(
	BID INT PRIMARY KEY,
	THUMB_NUM INT,
	TITLE CHAR(40),
	PYEAR INT,
	PMONTH INT,
	PDAY INT,
	CONT VARCHAR(4000),
	FOREIGN KEY (BID)
	REFERENCES MBLOG(BID)
	ON DELETE CASCADE
	ON UPDATE CASCADE
);

DROP PROCEDURE IF EXISTS UPDATE_THUMB;
DELIMITER $
CREATE PROCEDURE UPDATE_THUMB()
BEGIN
	DELETE FROM TOPTHUMB;
	INSERT INTO TOPTHUMB(BID, THUMB_NUM, TITLE, PYEAR, PMONTH, PDAY, CONT)
	SELECT MBLOG.BID, COUNT(*), TITLE, PYEAR, PMONTH, PDAY, CONT
	FROM MBLOG, THUMB
	WHERE MBLOG.BID = THUMB.BID AND
	MBLOG.PYEAR = year(now()) AND 
	MBLOG.PMONTH = month(now()) AND
	MBLOG.PDAY = day(now())
	GROUP BY MBLOG.BID
	ORDER BY COUNT(*) LIMIT 10;
END
$

DELIMITER ;

INSERT INTO MBLOG VALUES(101, '微博1', 1, 2019, 5, 6, '内容1');
INSERT INTO MBLOG VALUES(102, '微博2', 1, 2019, 5, 6, '内容2');
INSERT INTO MBLOG VALUES(103, '微博3', 1, 2019, 5, 6, '内容3');
INSERT INTO MBLOG VALUES(104, '微博4', 1, 2019, 5, 6, '内容4');
INSERT INTO MBLOG VALUES(105, '微博5', 1, 2019, 5, 6, '内容5');
INSERT INTO MBLOG VALUES(106, '微博6', 1, 2019, 5, 6, '内容6');
INSERT INTO MBLOG VALUES(107, '微博7', 1, 2019, 5, 6, '内容7');
INSERT INTO MBLOG VALUES(108, '微博8', 1, 2019, 5, 6, '内容8');
INSERT INTO MBLOG VALUES(109, '微博9', 1, 2019, 5, 6, '内容9');
INSERT INTO MBLOG VALUES(110, '微博10', 1, 2019, 5, 6, '内容10');
INSERT INTO MBLOG VALUES(111, '微博11', 1, 2019, 5, 6, '内容11');
INSERT INTO MBLOG VALUES(112, '微博12', 1, 2019, 5, 6, '内容12');
INSERT INTO MBLOG VALUES(113, '微博13', 1, 2019, 5, 6, '内容13');

INSERT INTO THUMB VALUES(2, 101);
INSERT INTO THUMB VALUES(2, 102);
INSERT INTO THUMB VALUES(2, 102);
INSERT INTO THUMB VALUES(2, 102);
INSERT INTO THUMB VALUES(2, 103);
INSERT INTO THUMB VALUES(2, 103);
INSERT INTO THUMB VALUES(2, 103);
INSERT INTO THUMB VALUES(2, 103);
INSERT INTO THUMB VALUES(2, 104);
INSERT INTO THUMB VALUES(2, 104);
INSERT INTO THUMB VALUES(2, 104);
INSERT INTO THUMB VALUES(2, 104);
INSERT INTO THUMB VALUES(2, 104);
INSERT INTO THUMB VALUES(2, 104);
INSERT INTO THUMB VALUES(2, 104);
INSERT INTO THUMB VALUES(2, 105);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 106);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 107);
INSERT INTO THUMB VALUES(2, 108);
INSERT INTO THUMB VALUES(2, 109);
INSERT INTO THUMB VALUES(2, 109);
INSERT INTO THUMB VALUES(2, 109);
INSERT INTO THUMB VALUES(2, 110);
INSERT INTO THUMB VALUES(2, 110);
INSERT INTO THUMB VALUES(2, 110);
INSERT INTO THUMB VALUES(2, 111);
INSERT INTO THUMB VALUES(2, 111);
INSERT INTO THUMB VALUES(2, 111);
INSERT INTO THUMB VALUES(2, 111);
INSERT INTO THUMB VALUES(2, 112);
INSERT INTO THUMB VALUES(2, 112);
INSERT INTO THUMB VALUES(2, 112);
INSERT INTO THUMB VALUES(2, 113);
INSERT INTO THUMB VALUES(2, 113);
INSERT INTO THUMB VALUES(2, 113);
INSERT INTO THUMB VALUES(2, 113);
INSERT INTO THUMB VALUES(2, 113);
INSERT INTO THUMB VALUES(2, 113);
INSERT INTO THUMB VALUES(2, 113);

CALL UPDATE_THUMB();
SELECT * FROM TOPTHUMB;

DELIMITER $
CREATE TRIGGER TR_THUMB_INSERT
AFTER INSERT ON THUMB
FOR EACH ROW
BEGIN
CALL UPDATE_THUMB();
END$
DELIMITER ;

DELIMITER $
CREATE TRIGGER TR_THUMB_UPDATE
AFTER UPDATE ON THUMB
FOR EACH ROW
BEGIN
CALL UPDATE_THUMB();
END$
DELIMITER ;

DELIMITER $
CREATE TRIGGER TR_THUMB_DEL
AFTER DELETE ON THUMB
FOR EACH ROW
BEGIN
CALL UPDATE_THUMB();
END$
DELIMITER ;

INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
INSERT INTO THUMB VALUES(3, 113);
